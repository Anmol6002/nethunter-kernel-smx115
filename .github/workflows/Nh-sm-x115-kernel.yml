name: Build Kali NetHunter Kernel for SM-X115

on:
  workflow_dispatch:

jobs:
  build:
    name: Compile Kernel & Create Magisk Flashable ZIP
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Clone Kernel Source
      uses: actions/checkout@v4
      with:
        repository: Anmol6002/kernel_source_sm-x115
        ref: main
        path: kernel

    - name: ðŸ§° Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y bc bison flex libssl-dev libncurses5-dev \
          libelf-dev build-essential git wget cpio rsync zip unzip python3

    - name: ðŸ”§ Clone AOSP GCC Toolchain
      run: |
        git clone --depth=1 https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 \
          -b android10-release toolchain64
        echo "CROSS_COMPILE=$(pwd)/toolchain64/bin/aarch64-linux-android-" >> $GITHUB_ENV

    - name: ðŸ©¹ Patch defconfig with NetHunter configs
      working-directory: kernel
      run: |
        DEFCONFIG="arch/arm64/configs/gta9_defconfig"
        echo -e "\n# --- NetHunter Config Patches ---" >> $DEFCONFIG
        curl -sSL https://raw.githubusercontent.com/Anmol6002/nethunter-kernel-smx115/main/gta9_defconfig_patched.config >> $DEFCONFIG
        echo -e "# --- End Patch ---\n" >> $DEFCONFIG

    - name: ðŸŽ§ Inline Patch: Sound Driver Configs
      working-directory: kernel
      run: |
        DEFCONFIG="arch/arm64/configs/gta9_defconfig"
        echo -e "\n# --- Sound Driver Configs ---" >> $DEFCONFIG
        cat <<EOF >> $DEFCONFIG
CONFIG_SND=y
CONFIG_SND_SOC=y
CONFIG_SND_DYNAMIC_MINORS=y
CONFIG_SND_PROC_FS=y
CONFIG_SND_VERBOSE_PRINTK=y
CONFIG_SND_VERBOSE_PROCFS=y
CONFIG_SND_SOC_MTK_BTCVSD=y
CONFIG_SND_SOC_MTK_AUDIO=y
CONFIG_SND_SIMPLE_CARD=y
CONFIG_SND_USB_AUDIO=y
CONFIG_SND_SOC_DUMMY_CODEC=y
CONFIG_SND_SOC_GENERIC_DMAENGINE_PCM=y
EOF
        echo "# --- End Sound Patch ---" >> $DEFCONFIG

    - name: ðŸ› ï¸ Compile Kernel & Modules
      working-directory: kernel
      run: |
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=${{ env.CROSS_COMPILE }}
        export KMI_SYMBOL_LIST_STRICT_MODE=0
        export LOCALVERSION=""

        make gta9_defconfig

        # Disable ABI enforcement
        ./scripts/config --file .config --undefine KMI_SYMBOL_LIST_STRICT_MODE
        ./scripts/config --file .config --undefine KMI_SYMBOL_LIST
        ./scripts/config --file .config --undefine KMI_WHITELIST

        make olddefconfig
        make -j$(nproc)
        make modules -j$(nproc)

        mkdir -p ../out/modules_install
        make INSTALL_MOD_PATH=../out/modules_install modules_install

    - name: ðŸ“¦ Pack modules.tar.gz
      run: |
        cd out/modules_install
        tar -czf ../../modules.tar.gz lib

    - name: ðŸ“ Clone AnyKernel3 & Setup
      run: |
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git anykernel
        cp kernel/arch/arm64/boot/Image.gz anykernel/
        if [ -d kernel/arch/arm64/boot/dts ]; then
          find kernel/arch/arm64/boot/dts -name "*.dtb" -exec cat {} + > anykernel/dtb
          cat anykernel/Image.gz anykernel/dtb > anykernel/Image.gz-dtb
        else
          cp anykernel/Image.gz anykernel/Image.gz-dtb
        fi
        mkdir -p anykernel/lib/modules
        tar -xzf modules.tar.gz -C anykernel/
        sed -i 's/is_slot_device=0/is_slot_device=1/' anykernel/anykernel.sh
        sed -i 's@kernel_string=.*@kernel_string="NetHunter Kernel for SM-X115"@' anykernel/anykernel.sh
        sed -i 's/skip_initramfs=0/skip_initramfs=1/' anykernel/anykernel.sh
        echo "Init.d support enabled"

    - name: ðŸ“¦ Create Magisk Flashable ZIP
      run: |
        cd anykernel
        zip -r9 ../NetHunter-Kernel-SMX115.zip ./*

    - name: ðŸ“¤ Upload ZIP to Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: NetHunter-Kernel-SMX115
        path: NetHunter-Kernel-SMX115.zip

    - name: ðŸš€ OPTIONAL:Push to GitHub Releases
      if: ${{ false }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: nethunter-smx115-latest
        name: NetHunter Kernel SM-X115
        files: NetHunter-Kernel-SMX115.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
