name: Build NetHunter Kernel for SM-X115

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ“¥ Checkout Patch Repo (this repo)
        uses: actions/checkout@v3

      - name: ğŸ“¥ Clone Kernel Source
        run: |
          git clone --depth=1 https://github.com/Anmol6002/kernel_source_sm-x115 kernel-source

      - name: ğŸ§¹ Clean Kernel Source (make mrproper)
        run: |
          cd kernel-source
          make mrproper
          
      - name: ğŸ› ï¸ Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential bc bison flex libssl-dev \
            libncurses5-dev libncursesw5-dev git python3 rsync \
            cpio lzop ccache libelf-dev zip

      - name: ğŸ”§ Setup Toolchain
        run: |
         git clone --depth=1 -b android10-release https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 toolchain
         echo "TOOLCHAIN=$GITHUB_WORKSPACE/toolchain/bin/aarch64-linux-android-" >> $GITHUB_ENV

      - name: ğŸ§© Merge Patched Config
        run: |
          cd kernel-source
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=$TOOLCHAIN

          make O=out gta9_defconfig
          cp $GITHUB_WORKSPACE/gta9_defconfig_patched.config .
          bash scripts/kconfig/merge_config.sh -m out/.config gta9_defconfig_patched.config
          cp out/.config arch/arm64/configs/gta9_defconfig

      - name: âš™ï¸ Build Kernel + Modules
        run: |
          cd kernel-source
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=$TOOLCHAIN

          make O=out gta9_defconfig
          make -j$(nproc) O=out

          # Install modules into staging folder
          make O=out INSTALL_MOD_PATH=$GITHUB_WORKSPACE/modules modules_install

      - name: ğŸ“ Prepare AnyKernel3 (with init.d and modules)
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git
          cd AnyKernel3

          # Add kernel image
          cp ../kernel-source/out/arch/arm64/boot/Image.gz-dtb zImage

          # Add modules
          if [ -d "$GITHUB_WORKSPACE/modules/lib/modules" ]; then
            mkdir -p modules
            find $GITHUB_WORKSPACE/modules/lib/modules/ -name '*.ko' -exec cp {} modules/ \;
          fi

          # Enable module and init.d support
          sed -i 's/MODULES=false/MODULES=true/' anykernel.sh
          sed -i 's/INITD=false/INITD=true/' anykernel.sh

          # Add init.d test script
          mkdir -p init.d
          echo -e '#!/system/bin/sh\necho "NetHunter init.d test script ran at boot."' > init.d/99nethunter.sh
          chmod +x init.d/99nethunter.sh

      - name: ğŸ“¦ Create Flashable Zip
        run: |
          cd AnyKernel3
          zip -r9 NetHunter-Kernel-SMX115.zip * -x '*.git*' README.md *.md

      - name: â˜ï¸ Upload Flashable Kernel
        uses: actions/upload-artifact@v4
        with:
          name: NetHunter-Kernel-SMX115
          path: AnyKernel3/NetHunter-Kernel-SMX115.zip
