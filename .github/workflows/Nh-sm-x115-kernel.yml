name: Build NetHunter Kernel for SM-X115

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: üì• Checkout This Repo
        uses: actions/checkout@v3

      - name: üì• Clone Kernel Source
        run: |
          mkdir kernel-source
          git clone --depth=1 https://github.com/Anmol6002/kernel_source_sm-x115.git kernel-source

      - name: üß© Add CAN support submodules and patch kernel tree
        shell: bash
        run: |
          cd kernel-source
          mkdir -p drivers/net/can include/uapi/linux/can

          git submodule add https://github.com/V0lk3n/usb-can-2-module drivers/net/can/usb-can-2-module || true
          git submodule add https://github.com/V0lk3n/can-isotp drivers/net/can/can-isotp || true
          git submodule add https://github.com/V0lk3n/elmcan drivers/net/can/elmcan || true
          git submodule update --init --recursive

          echo 'source "drivers/net/can/usb-can-2-module/Kconfig"' >> drivers/net/can/Kconfig
          echo 'source "drivers/net/can/can-isotp/Kconfig"' >> drivers/net/can/Kconfig
          echo '' >> drivers/net/can/Kconfig

          echo 'config CAN_CAN327' >> drivers/net/can/Kconfig
          echo '	tristate "Serial / USB serial ELM327 based OBD-II Interfaces (can327)"' >> drivers/net/can/Kconfig
          echo '	depends on TTY' >> drivers/net/can/Kconfig
          echo '	select CAN_RX_OFFLOAD' >> drivers/net/can/Kconfig
          echo '	help' >> drivers/net/can/Kconfig
          echo '	  CAN driver for several '\''low cost'\'' OBD-II interfaces based on the' >> drivers/net/can/Kconfig
          echo '	  ELM327 OBD-II interpreter chip.' >> drivers/net/can/Kconfig
          echo '' >> drivers/net/can/Kconfig
          echo '	  This is a best effort driver - the ELM327 interface was never' >> drivers/net/can/Kconfig
          echo '	  designed to be used as a standalone CAN interface. However, it can' >> drivers/net/can/Kconfig
          echo '	  still be used for simple request-response protocols (such as OBD II),' >> drivers/net/can/Kconfig
          echo '	  and to monitor broadcast messages on a bus (such as in a vehicle).' >> drivers/net/can/Kconfig
          echo '' >> drivers/net/can/Kconfig
          echo '	  Please refer to the documentation for information on how to use it:' >> drivers/net/can/Kconfig
          echo '	  Documentation/networking/device_drivers/can/can327.rst' >> drivers/net/can/Kconfig

          echo 'obj-y += usb-can-2-module/' >> drivers/net/can/Makefile
          echo 'obj-y += can-isotp/' >> drivers/net/can/Makefile
          echo 'obj-$(CONFIG_CAN_CAN327) += can327.o' >> drivers/net/can/Makefile

          cp drivers/net/can/elmcan/can327.c drivers/net/can/
          curl -Lo include/uapi/linux/can/isotp.h https://raw.githubusercontent.com/V0lk3n/can-isotp/master/include/uapi/linux/can/isotp.h

      - name: üß™ Verify CAN integration
        run: |
         echo "========== Kconfig (last 30 lines) =========="
         tail -n 30 kernel-source/drivers/net/can/Kconfig || echo "‚ùå Kconfig not found!"

         echo
         echo "========== Makefile (last 10 lines) =========="
         tail -n 10 kernel-source/drivers/net/can/Makefile || echo "‚ùå Makefile not found!"

         echo
         echo "========== can327.c exists? =========="
         ls -lh kernel-source/drivers/net/can/can327.c || echo "‚ùå can327.c missing!"

         echo
         echo "========== isotp.h exists? =========="
         ls -lh kernel-source/include/uapi/linux/can/isotp.h || echo "‚ùå isotp.h missing!"
 
         echo
         echo "========== Cloned CAN submodules =========="
         ls -1 kernel-source/drivers/net/can/ || echo "‚ùå Submodules missing!"

      - name: üõ†Ô∏è Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential bc bison flex libssl-dev \
            libncurses5-dev libncursesw5-dev git python3 rsync \
            cpio lzop ccache libelf-dev zip

      - name: üîß Install GCC Cross-Compiler for Android Kernel
        run: |
         sudo apt update
         sudo apt install -y gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu
         echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV

      

      - name: ü©π Disable ABI Check in Makefiles
        run: |
          grep -rl 'abi_symbollist.raw' kernel-source | while read file; do
            echo "Disabling ABI check in $file"
            sed -i '/abi_symbollist.raw/ s/^/#/' "$file"
          done

      - name: üßπ Clean Tree (mrproper)
        run: |
          cd kernel-source
          export ARCH=arm64
          export SUBARCH=arm64
          make mrproper

      - name: üß© Merge NetHunter Patches into Kernel defconfig
        run: |
         cd kernel-source
         export ARCH=arm64
         export SUBARCH=arm64
         export CROSS_COMPILE=aarch64-linux-gnu-
         

         echo "üßπ Resetting original defconfig"
         make gta9_defconfig

         echo "üõ†Ô∏è Cleaning up INIT_STACK_ entries before merge"
         sed -i '/^CONFIG_INIT_STACK_/d' arch/arm64/configs/gta9_defconfig || true
         sed -i '/^CONFIG_INIT_STACK_/d' $GITHUB_WORKSPACE/gta9_defconfig_patched.config || true
         echo 'CONFIG_INIT_STACK_ALL_ZERO=y' >> $GITHUB_WORKSPACE/gta9_defconfig_patched.config

         echo "üß© Merging NetHunter config..."
         cp $GITHUB_WORKSPACE/gta9_defconfig_patched.config .
         bash scripts/kconfig/merge_config.sh -m .config gta9_defconfig_patched.config

         echo "‚öôÔ∏è Resolving final config..."
         make olddefconfig

         echo "üíæ Saving merged config to gta9_defconfig"
         cp .config arch/arm64/configs/gta9_defconfig

      - name: üßº Clean After Merging defconfig
        run: |
         cd kernel-source
         export ARCH=arm64
         export SUBARCH=arm64
         make mrproper
  
      - name: üßπ Fix Kconfig newline warning
        run: |
          cd kernel-source
          echo >> drivers/gpu/drm/mediatek/Kconfig
          
      - name: üõ†Ô∏è Final Kernel Patches and Fixes
        run: |
          echo "‚úÖ Using gta9_defconfig with manual patches"
          DEFCONFIG="kernel-source/arch/arm64/configs/gta9_defconfig"

          echo "üßπ Sorting and cleaning defconfig"
          sort -u "$DEFCONFIG" -o "$DEFCONFIG"

          echo "‚öôÔ∏è Ensuring CAN macro exists"
          CAN_HEADER="kernel-source/include/uapi/linux/can/isotp.h"
          grep -q "CAN_ISOTP_CF_BROADCAST" "$CAN_HEADER" || echo '#define CAN_ISOTP_CF_BROADCAST 0x80' >> "$CAN_HEADER"

          echo "‚úÖ Final patching step complete!"

      - name: üîç Locate risky strncpy usage
        run: |
         cd kernel-source
         grep -rn 'strncpy' drivers/ include/ || echo "No strncpy found"
         
      - name: üßº Clean Tree and Recreate Output Dir
        run: |
         cd kernel-source
         make mrproper
         rm -rf out
         mkdir -p out

      - name: üõ† Patch printk %u + u64 format issues
        run: |
          cd kernel-source
          echo "üîç Searching for unsafe printk %%u usage with u64-type vars..."

          U64_HINTS="time|timestamp|ino|offset|chunk|value|size|bytes|ratio|cold"

          find . -type f \( -name "*.c" -o -name "*.h" \) > all_files.txt

          echo "üîê Backing up all .c/.h files before patching..."
          for f in $(cat all_files.txt); do cp "$f" "$f.bak"; done

          echo "‚öôÔ∏è  Scanning for printk() and pr_*() using %u with u64-ish args..."
          xargs grep -nH 'printk(.*%u' < all_files.txt | grep -E "\b($U64_HINTS)\b" > suspicious_lines.txt || true
          xargs grep -nH 'pr_.*(.*%u' < all_files.txt | grep -E "\b($U64_HINTS)\b" >> suspicious_lines.txt || true

          echo "üîß Replacing '%u' with '%llu' and casting args to (unsigned long long)..."
          while IFS= read -r line; do
            file=$(echo "$line" | cut -d':' -f1)
            lineno=$(echo "$line" | cut -d':' -f2)
            content=$(sed "${lineno}q;d" "$file")

            modified=$(echo "$content" | sed 's/%u/%llu/')
            modified=$(echo "$modified" | sed -E "s/([, \(])\s*($U64_HINTS)\b/\1(unsigned long long) \2/")

            echo "$modified" | sed "${lineno}s/.*/$(sed 's/[&/\]/\\&/g' <<< "$modified")/" -i "$file"
            echo "‚úÖ Patched $file:$lineno"
          done < suspicious_lines.txt

          echo "üéâ All potential %u + u64 format errors fixed."

      - name: üîß Patch strncpy ‚Üí strscpy
        run: |
          cd kernel-source
          echo "üîç Scanning only kernel C files (excluding scripts/) for strncpy..."
          find . -type f \( -name "*.c" -o -name "*.h" \) ! -path "./scripts/*" > all_files.txt
          for f in $(cat all_files.txt); do cp "$f" "$f.bak"; done
          xargs grep -nH 'strncpy(' < all_files.txt > strncpy_lines.txt || true
          while IFS= read -r line; do
            file=$(echo "$line" | cut -d':' -f1)
            lineno=$(echo "$line" | cut -d':' -f2)
            content=$(sed "${lineno}q;d" "$file")
            fixed=$(echo "$content" | sed 's/\bstrncpy\b/strscpy/')
            echo "$fixed" | sed "${lineno}s/.*/$(sed 's/[&/\]/\\&/g' <<< "$fixed")/" -i "$file"
            echo "‚úÖ Patched $file:$lineno"
          done < strncpy_lines.txt

      - name: ü©π Fix strscpy duplicate declarations
        run: |
         cd kernel-source
         FILE=include/linux/string.h
         echo "üîç Patching duplicate strscpy declarations in $FILE..."
         sed -i '/extern char \* strscpy.*__kernel_size_t/d' $FILE
         grep -q "ssize_t strscpy" $FILE || echo 'ssize_t strscpy(char *dest, const char *src, size_t count);' >> $FILE
         echo "‚úÖ Patched strscpy declaration"
     
      - name: ‚öôÔ∏è Build Kernel + Modules with GCC
        run: |
         cd kernel-source
         export ARCH=arm64
         export SUBARCH=arm64
         export CROSS_COMPILE=$CROSS_COMPILE
         echo "üìÑ Using merged gta9_defconfig"
         
         cp arch/arm64/configs/gta9_defconfig out/.config
         make O=out olddefconfig

         echo "üî® Starting kernel build..."
         make -j$(nproc) O=out \
         CROSS_COMPILE=$CROSS_COMPILE \
         2>&1 | tee out/build.log || true

         echo "üì¶ Attempting modules_install..."
         make O=out INSTALL_MOD_PATH=$GITHUB_WORKSPACE/modules modules_install 2>&1 | tee -a out/build.log || true

         echo "üßæ Kernel Build Summary (errors & warnings):"
         echo "========== ERRORS === WARNINGS =========="
         grep -i "warning:" out/build.log || echo "‚úÖ No build warnings found."
         echo "üì¶ Verifying build outputs..."

         file out/arch/arm64/boot/Image || echo "‚ùå Kernel Image not found!"
         [ -f out/.config ] && echo "‚úÖ Kernel config (.config) found." || echo "‚ùå .config not found!"
         find $GITHUB_WORKSPACE/modules -name '*.ko' | grep -q . && echo "‚úÖ Kernel modules (*.ko) found." || echo "‚ö†Ô∏è No kernel modules found."

      - name: üß™ Scan for Format Specifier Type Mismatches
        run: |
         cd kernel-source
         echo "üß™ Checking printk/pr_* with %u and u64..."
         grep -RinP 'printk\s*\(.*%u' kernel/ include/ | grep -C 3 -i 'u64' || echo "‚úÖ No printk %u + u64 issue"
         grep -RinP 'pr_\w+\s*\(.*%u' kernel/ include/ | grep -C 3 -i 'u64' || echo "‚úÖ No pr_* %u + u64 issue"
         

      - name: üì• Download dtbo.img from GitHub Release
        run: |
         curl -L -o kernel-source/out/arch/arm64/boot/dtbo.img \
         https://github.com/Anmol6002/nethunter-kernel-smx115/releases/download/v1.0-dtbo/dtbo.img

      - name: üì¶ Create Image.gz-dtb if missing
        run: |
          cd kernel-source
          if [ ! -f out/arch/arm64/boot/Image.gz-dtb ]; then
            echo "‚ö†Ô∏è Image.gz-dtb not found. Trying to generate..."
            if [ -f out/arch/arm64/boot/Image ] && [ -f out/arch/arm64/boot/dtbo.img ]; then
              echo "‚úÖ Found Image and dtbo.img, creating Image.gz-dtb"
              gzip -c out/arch/arm64/boot/Image > out/arch/arm64/boot/Image.gz
              cat out/arch/arm64/boot/Image.gz out/arch/arm64/boot/dtbo.img > out/arch/arm64/boot/Image.gz-dtb
            else
              echo "‚ùå Required Image or dtbo.img not found. Kernel image creation failed."
              exit 1
            fi
          fi

      - name: ‚¨ÖÔ∏è Return to Workspace Root
        run: cd $GITHUB_WORKSPACE

      - name: üìÅ Prepare AnyKernel3 (with modules + init.d)
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git
          cd AnyKernel3
          
          # ‚úÖ Copy zImage
          cp ../kernel-source/out/arch/arm64/boot/Image.gz-dtb zImage || { echo "‚ùå Image.gz-dtb missing!"; exit 1; }
          
          # ‚úÖ Copy modules if available
          if [ -d "$GITHUB_WORKSPACE/modules/lib/modules" ]; then
            echo "üì¶ Copying modules..."
            mkdir -p modules
            find $GITHUB_WORKSPACE/modules/lib/modules/ -name '*.ko' -exec cp {} modules/ \;
          else
            echo "‚ö†Ô∏è No modules directory found ‚Äî skipping module copy."
          fi

          # ‚úÖ Enable modules and init.d in anykernel.sh
          sed -i 's/MODULES=false/MODULES=true/' anykernel.sh
          sed -i 's/INITD=false/INITD=true/' anykernel.sh

          # ‚úÖ Add test init.d script
          mkdir -p init.d
          echo -e '#!/system/bin/sh\necho "NetHunter init.d test script ran at boot."' > init.d/99nethunter.sh
          chmod +x init.d/99nethunter.sh
          
          # ‚úÖ Add kernel config.gz (for inspection/debugging)
          cp ../kernel-source/out/.config config.gz
          gzip -f config.gz

      - name: üßæ Add NetHunter Kernel Props (Magisk detection)
        run: |
          cd AnyKernel3
          echo "nethunter.kernel=1" > default.prop
          echo "nethunter.kernel.version=SM-X115-$(date +%Y%m%d)" >> default.prop
          echo "nethunter.kernel.initd=1" >> default.prop
          echo "nethunter.kernel.usbgadget=1" >> default.prop
          echo "nethunter.kernel.modules=1" >> default.prop

      - name: üì¶ Create Flashable Kernel Zip
        run: |
          cd AnyKernel3
          zip -r9 NetHunter-Kernel-SMX115.zip * -x '*.git*' README.md *.md

      - name: ‚òÅÔ∏è Upload Flashable Kernel
        uses: actions/upload-artifact@v4
        with:
          name: NetHunter-Kernel-SMX115
          path: AnyKernel3/NetHunter-Kernel-SMX115.zip

      - name: üì§ Upload Full Build Log
        uses: actions/upload-artifact@v4
        with:
          name: full-build-log
          path: kernel-source/out/build.log
