name: Build NetHunter Kernel for SM-X115

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ“¥ Checkout This Repo
        uses: actions/checkout@v3

      - name: ğŸ“¥ Clone Kernel Source
        run: |
          mkdir kernel-source
          git clone --depth=1 https://github.com/Anmol6002/kernel_source_sm-x115.git kernel-source

      - name: ğŸ§© Add CAN support submodules and patch kernel tree
        shell: bash
        run: |
          cd kernel-source
          mkdir -p drivers/net/can include/uapi/linux/can

          git submodule add https://github.com/V0lk3n/usb-can-2-module drivers/net/can/usb-can-2-module || true
          git submodule add https://github.com/V0lk3n/can-isotp drivers/net/can/can-isotp || true
          git submodule add https://github.com/V0lk3n/elmcan drivers/net/can/elmcan || true
          git submodule update --init --recursive

          echo 'source "drivers/net/can/usb-can-2-module/Kconfig"' >> drivers/net/can/Kconfig
          echo 'source "drivers/net/can/can-isotp/Kconfig"' >> drivers/net/can/Kconfig
          echo '' >> drivers/net/can/Kconfig

          echo 'config CAN_CAN327' >> drivers/net/can/Kconfig
          echo '	tristate "Serial / USB serial ELM327 based OBD-II Interfaces (can327)"' >> drivers/net/can/Kconfig
          echo '	depends on TTY' >> drivers/net/can/Kconfig
          echo '	select CAN_RX_OFFLOAD' >> drivers/net/can/Kconfig
          echo '	help' >> drivers/net/can/Kconfig
          echo '	  CAN driver for several '\''low cost'\'' OBD-II interfaces based on the' >> drivers/net/can/Kconfig
          echo '	  ELM327 OBD-II interpreter chip.' >> drivers/net/can/Kconfig
          echo '' >> drivers/net/can/Kconfig
          echo '	  This is a best effort driver - the ELM327 interface was never' >> drivers/net/can/Kconfig
          echo '	  designed to be used as a standalone CAN interface. However, it can' >> drivers/net/can/Kconfig
          echo '	  still be used for simple request-response protocols (such as OBD II),' >> drivers/net/can/Kconfig
          echo '	  and to monitor broadcast messages on a bus (such as in a vehicle).' >> drivers/net/can/Kconfig
          echo '' >> drivers/net/can/Kconfig
          echo '	  Please refer to the documentation for information on how to use it:' >> drivers/net/can/Kconfig
          echo '	  Documentation/networking/device_drivers/can/can327.rst' >> drivers/net/can/Kconfig

          echo 'obj-y += usb-can-2-module/' >> drivers/net/can/Makefile
          echo 'obj-y += can-isotp/' >> drivers/net/can/Makefile
          echo 'obj-$(CONFIG_CAN_CAN327) += can327.o' >> drivers/net/can/Makefile

          cp drivers/net/can/elmcan/can327.c drivers/net/can/
          curl -Lo include/uapi/linux/can/isotp.h https://raw.githubusercontent.com/V0lk3n/can-isotp/master/include/uapi/linux/can/isotp.h

      - name: ğŸ§ª Verify CAN integration
        run: |
         echo "========== Kconfig (last 30 lines) =========="
         tail -n 30 kernel-source/drivers/net/can/Kconfig || echo "âŒ Kconfig not found!"

         echo
         echo "========== Makefile (last 10 lines) =========="
         tail -n 10 kernel-source/drivers/net/can/Makefile || echo "âŒ Makefile not found!"

         echo
         echo "========== can327.c exists? =========="
         ls -lh kernel-source/drivers/net/can/can327.c || echo "âŒ can327.c missing!"

         echo
         echo "========== isotp.h exists? =========="
         ls -lh kernel-source/include/uapi/linux/can/isotp.h || echo "âŒ isotp.h missing!"
 
         echo
         echo "========== Cloned CAN submodules =========="
         ls -1 kernel-source/drivers/net/can/ || echo "âŒ Submodules missing!"

      

# âœ… INSERT THIS NEW FIX BLOCK HERE:

      - name: ğŸ› ï¸ Apply Kernel Fixes (CAN & MTK)
        run: |
          echo "âœ… Fixing missing macro: CAN_ISOTP_CF_BROADCAST"
          ISOTP_HEADER="kernel-source/include/uapi/linux/can/isotp.h"
          if ! grep -q "CAN_ISOTP_CF_BROADCAST" "$ISOTP_HEADER"; then
            echo '#define CAN_ISOTP_CF_BROADCAST 0x80' >> "$ISOTP_HEADER"
            echo "âœ… Added CAN_ISOTP_CF_BROADCAST to $ISOTP_HEADER"
          else
            echo "â„¹ï¸ CAN_ISOTP_CF_BROADCAST already defined"
          fi

          echo "âœ… Fixing invalid '&' bitwise usage in devapc-mtk-multi-ao.c"
          DEVAPC_FILE="kernel-source/drivers/soc/mediatek/devapc/devapc-mtk-multi-ao.c"
          if [ -f "$DEVAPC_FILE" ]; then
            sed -i 's/\([a-zA-Z0-9_]\) & \([a-zA-Z0-9_]\)/\1 \&\& \2/g' "$DEVAPC_FILE"
            echo "âœ… Fixed bitwise '&' in $DEVAPC_FILE"
          else
            echo "âŒ $DEVAPC_FILE not found!"
          fi

          echo "âœ… Cleaning duplicate CONFIG entries from defconfig"
          DEFCONFIG="kernel-source/arch/arm64/configs/gta9_defconfig"
          for sym in CONFIG_USB_GADGET_DEBUG_FILES CONFIG_TMPFS CONFIG_TMPFS_POSIX_ACL CONFIG_PROC_FS CONFIG_PROC_PID_CPUSET CONFIG_SYSFS CONFIG_SECURITYFS; do
            sed -i "/^$sym=.*/d" "$DEFCONFIG"
            echo "âœ… Removed duplicate $sym"
          done

          echo "âœ… Ensuring SND_SOC_MT6366 and dependencies are properly set"
          for sym in CONFIG_SND_SOC_MT6366 CONFIG_MFD_MT6366 CONFIG_GPIOLIB CONFIG_REGMAP_I2C CONFIG_SND_SOC_COMPONENT; do
            grep -q "^$sym=" "$DEFCONFIG" || echo "$sym=y" >> "$DEFCONFIG"
            echo "âœ… $sym=y"
          done

          echo "ğŸ§¼ Done patching kernel source tree before build"

      - name: ğŸ› ï¸ Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential bc bison flex libssl-dev \
            libncurses5-dev libncursesw5-dev git python3 rsync \
            cpio lzop ccache libelf-dev zip

      - name: ğŸ”§ Setup Clang Toolchain (auto-detect version)
        run: |
         git clone --depth=1 https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 clang-toolchain
         CLANG_DIR=$(find clang-toolchain -maxdepth 1 -type d -name "clang-r*" | head -n 1)
         echo "CLANG_PATH=$GITHUB_WORKSPACE/$CLANG_DIR" >> $GITHUB_ENV
         echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV

      - name: ğŸ”§ Install GCC Cross-Compiler for Android Kernel 5.15+
        run: |
         sudo apt update
         sudo apt install -y gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu
         echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV

      - name: ğŸ©¹ Disable ABI Check in Makefiles
        run: |
          grep -rl 'abi_symbollist.raw' kernel-source | while read file; do
            echo "Disabling ABI check in $file"
            sed -i '/abi_symbollist.raw/ s/^/#/' "$file"
          done

      - name: ğŸ§¹ Clean Tree (mrproper)
        run: |
          cd kernel-source
          export ARCH=arm64
          export SUBARCH=arm64
          make mrproper

      - name: ğŸ§© Merge Patched defconfig
        run: |
          cd kernel-source
          export ARCH=arm64
          export SUBARCH=arm64
          make gta9_defconfig
          cp $GITHUB_WORKSPACE/gta9_defconfig_patched.config .
          bash scripts/kconfig/merge_config.sh -m .config gta9_defconfig_patched.config
          cp .config arch/arm64/configs/gta9_defconfig
          make mrproper

      - name: ğŸ§¹ Fix Kconfig newline warning
        run: |
          cd kernel-source
          echo >> drivers/gpu/drm/mediatek/Kconfig

      - name: âš™ï¸ Build Kernel + Modules with Clang (non-fatal build)
        run: |
         cd kernel-source
         export ARCH=arm64
         export SUBARCH=arm64
         export CC=$CLANG_PATH/bin/clang
         export CROSS_COMPILE=$CROSS_COMPILE
         export CLANG_TRIPLE=$CLANG_TRIPLE

         echo "ğŸ“¦ Using Clang from: $CC"
         $CC --version || echo "âŒ Clang not found!"

         echo "ğŸ“¦ Using GCC Cross-Compiler:"
         aarch64-linux-gnu-gcc --version || echo "âŒ GCC not found!"

         echo "ğŸ“„ Running defconfig..."
         mkdir -p out
         make O=out gta9_defconfig > out/build.log 2>&1

         echo "ğŸ”¨ Starting kernel build (will continue on error)..."
         make -j$(nproc) O=out \
         CC=$CC \
         CROSS_COMPILE=$CROSS_COMPILE \
         CLANG_TRIPLE=$CLANG_TRIPLE \
         LD=aarch64-linux-gnu-ld \
         AR=aarch64-linux-gnu-ar \
         NM=aarch64-linux-gnu-nm \
         OBJCOPY=aarch64-linux-gnu-objcopy \
         OBJDUMP=aarch64-linux-gnu-objdump \
         STRIP=aarch64-linux-gnu-strip \
         2>&1 | tee -a out/build.log || true

         echo "ğŸ“¦ Attempting modules_install..."
         make O=out INSTALL_MOD_PATH=$GITHUB_WORKSPACE/modules modules_install >> out/build.log 2>&1 || true

         echo "ğŸ§¾ Kernel Build Summary (errors & warnings):"
         echo "========== ERRORS =========="
         grep -i "error:" out/build.log || echo "âœ… No build errors found."

         echo "========== WARNINGS =========="
         grep -i "warning:" out/build.log || echo "âœ… No build warnings found."

         echo "========== UNMET DEPENDENCIES =========="
         grep -i "unmet" out/build.log || echo "âœ… No unmet dependencies found."

         echo "ğŸ“¦ Verifying output image..."
         file out/arch/arm64/boot/Image.gz-dtb || echo "âŒ Output image not found!"
      
      # ... (everything before is the same as yours)

      - name: ğŸ“¦ Create Image.gz-dtb if missing
        run: |
          cd kernel-source
          if [ ! -f out/arch/arm64/boot/Image.gz-dtb ]; then
            echo "âš ï¸ Image.gz-dtb not found. Trying to generate..."
            if [ -f out/arch/arm64/boot/Image ] && [ -f out/arch/arm64/boot/dtbo.img ]; then
              echo "âœ… Found Image and dtbo.img, creating Image.gz-dtb"
              gzip -c out/arch/arm64/boot/Image > out/arch/arm64/boot/Image.gz
              cat out/arch/arm64/boot/Image.gz out/arch/arm64/boot/dtbo.img > out/arch/arm64/boot/Image.gz-dtb
            else
              echo "âŒ Required Image or dtbo.img not found. Kernel image creation failed."
              exit 1
            fi
          fi

      - name: ğŸ“ Prepare AnyKernel3 (with modules + init.d)
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git
          cd AnyKernel3
          
          # âœ… Copy zImage
          cp ../kernel-source/out/arch/arm64/boot/Image.gz-dtb zImage || { echo "âŒ Image.gz-dtb missing!"; exit 1; }
          
          # âœ… Copy modules if available
          if [ -d "$GITHUB_WORKSPACE/modules/lib/modules" ]; then
            echo "ğŸ“¦ Copying modules..."
            mkdir -p modules
            find $GITHUB_WORKSPACE/modules/lib/modules/ -name '*.ko' -exec cp {} modules/ \;
          else
            echo "âš ï¸ No modules directory found â€” skipping module copy."
          fi

          # âœ… Enable modules and init.d in anykernel.sh
          sed -i 's/MODULES=false/MODULES=true/' anykernel.sh
          sed -i 's/INITD=false/INITD=true/' anykernel.sh

          # âœ… Add test init.d script
          mkdir -p init.d
          echo -e '#!/system/bin/sh\necho "NetHunter init.d test script ran at boot."' > init.d/99nethunter.sh
          chmod +x init.d/99nethunter.sh

      - name: ğŸ§¾ Add NetHunter Kernel Props (Magisk detection)
        run: |
          cd AnyKernel3
          echo "nethunter.kernel=1" > default.prop
          echo "nethunter.kernel.version=SM-X115-$(date +%Y%m%d)" >> default.prop
          echo "nethunter.kernel.initd=1" >> default.prop
          echo "nethunter.kernel.usbgadget=1" >> default.prop
          echo "nethunter.kernel.modules=1" >> default.prop

      - name: ğŸ“¦ Create Flashable Kernel Zip
        run: |
          cd AnyKernel3
          zip -r9 NetHunter-Kernel-SMX115.zip * -x '*.git*' README.md *.md

      - name: â˜ï¸ Upload Flashable Kernel
        uses: actions/upload-artifact@v4
        with:
          name: NetHunter-Kernel-SMX115
          path: AnyKernel3/NetHunter-Kernel-SMX115.zip

      - name: ğŸ“¤ Upload Full Build Log
        uses: actions/upload-artifact@v4
        with:
          name: full-build-log
          path: kernel-source/out/build.log
